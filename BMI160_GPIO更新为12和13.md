# BMI160传感器GPIO引脚更新

## 更新时间
2025年10月23日

## 最新配置

### I2C引脚配置
```
SCL: GPIO12 ✅
SDA: GPIO13 ✅
I2C总线: I2C_NUM_0
I2C地址: 0x68（SAO接GND）
I2C频率: 400kHz
```

## 硬件接线

```
BMI160模块          ESP32板
─────────────      ─────────────
VIN/VCC      →     3.3V
GND          →     GND
SCL          →     GPIO12 ✅ 已更新
SDA          →     GPIO13 ✅ 已更新
CS           →     3.3V（启用I2C模式）
SAO/SDO      →     GND（I2C地址0x68）
```

## 代码修改

### 文件：main/sensor_manager.cc

```cpp
// I2C配置
#define I2C_SCL_IO      GPIO_NUM_12  // 已从GPIO18改为GPIO12
#define I2C_SDA_IO      GPIO_NUM_13  // 已从GPIO17改为GPIO13
#define I2C_FREQ_HZ     400000
```

## 编译和烧录

```bash
cd /Users/zhangzisong/Desktop/test1.1/xiaozhi-esp32-main

# 1. 设置ESP-IDF环境
. $HOME/esp/esp-idf/export.sh

# 2. 编译
idf.py build

# 3. 烧录
idf.py flash

# 4. 查看日志
idf.py monitor
```

## 预期日志输出

如果连接正确，您应该看到：

```
I (xxxx) SensorManager: 初始化传感器管理器...
I (xxxx) BMI160: 正在检测BMI160传感器...
I (xxxx) BMI160: BMI160 Chip ID: 0xD1
I (xxxx) BMI160: BMI160 初始化成功!
I (xxxx) SensorManager: BMI160传感器初始化成功!
I (xxxx) main: 传感器系统初始化成功
```

晃动设备时：
```
I (xxxx) SensorManager: === 检测到晃动! ===
I (xxxx) SensorManager: 加速度 [g]: X=0.523, Y=0.412, Z=1.234 | 陀螺仪 [°/s]: X=125.42, Y=-98.34, Z=45.67
```

## 引脚变更历史

| 版本 | SCL | SDA | 状态 |
|------|-----|-----|------|
| 最初 | GPIO9 | GPIO8 | I2C冲突 |
| 修改1 | GPIO18 | GPIO17 | 用户反馈错误 |
| 修改2 | GPIO12 | GPIO13 | ✅ 当前配置 |

## 注意事项

### GPIO12的特殊性（ESP32）

⚠️ **重要提示**：GPIO12在ESP32上有特殊用途：
- GPIO12在启动时用于设置flash电压
- 如果GPIO12在启动时为高电平，可能会影响启动

**通常情况下这不是问题**，但如果遇到启动问题：
- 确保BMI160模块在系统启动时不会拉高GPIO12
- 或者考虑使用其他GPIO（如GPIO14、GPIO15等）

### 确认接线

请确保：
1. ✅ BMI160的SCL现在连接到ESP32的GPIO12
2. ✅ BMI160的SDA现在连接到ESP32的GPIO13
3. ✅ CS引脚接到3.3V（启用I2C模式）
4. ✅ SAO引脚接地（I2C地址0x68）
5. ✅ VIN接到3.3V（不是5V）
6. ✅ GND接到GND

## 故障排查

如果还是不工作，请检查：

1. **硬件连接**
   - GPIO12和GPIO13是否接对？
   - CS是否接到3.3V？
   - 所有线是否插紧？

2. **电压测试**
   - 用万用表测量VIN：应该是3.3V
   - 测量CS：应该是3.3V
   - 测量SAO：应该是0V

3. **其他可能性**
   - 尝试交换GPIO12和GPIO13（确认是否接反）
   - 检查杜邦线是否完好
   - 确认BMI160模块工作正常

## 替代GPIO建议

如果GPIO12有问题，可以考虑：

**推荐的GPIO组合：**
- GPIO14(SCL) + GPIO15(SDA)
- GPIO25(SCL) + GPIO26(SDA)
- GPIO32(SCL) + GPIO33(SDA)

这些GPIO没有特殊启动功能，更安全。

## 完整系统配置

```
设备类型: bread-compact-wifi
显示器: 已禁用（NoDisplay）
I2C_NUM_0: BMI160传感器（GPIO12/GPIO13）
I2C_NUM_1: 空闲
传感器功能: 晃动检测
日志模式: 静止时无输出，晃动时显示
```

---

**配置已更新完成**：SCL=GPIO12, SDA=GPIO13

