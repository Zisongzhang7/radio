# BMI160 传感器最终配置说明

## ✅ 问题解决

### 根本原因
之前虽然修改了GPIO引脚（GPIO17/GPIO18），但传感器和显示器都在使用**同一个I2C总线编号（I2C_NUM_0）**。ESP32的I2C总线只能初始化一次，导致冲突。

### 解决方案
将传感器改用 **I2C_NUM_1** 总线，与显示器的 **I2C_NUM_0** 总线独立。

## 🔌 最终硬件接线

| BMI160引脚 | ESP32引脚 | 说明 |
|-----------|----------|------|
| VIN       | 3V3      | 电源 |
| SCL       | GPIO18   | I2C时钟线 |
| SDA       | GPIO17   | I2C数据线 |
| CS        | 3.3V     | 片选（拉高启用I2C模式）|
| SAO       | GND      | I2C地址选择（0x68）|

## 💻 最终代码配置

### main/sensor_manager.cc

```cpp
// I2C配置
#define I2C_SCL_IO      GPIO_NUM_18
#define I2C_SDA_IO      GPIO_NUM_17
#define I2C_FREQ_HZ     400000

bool SensorManager::Initialize() {
    ESP_LOGI(TAG, "初始化传感器管理器...");
    
    // 配置I2C总线 - 使用I2C_NUM_1避免与显示器的I2C_NUM_0冲突
    i2c_master_bus_config_t i2c_bus_config = {
        .i2c_port = I2C_NUM_1,  // ✅ 关键：使用I2C_NUM_1
        .sda_io_num = I2C_SDA_IO,
        .scl_io_num = I2C_SCL_IO,
        .clk_source = I2C_CLK_SRC_DEFAULT,
        .glitch_ignore_cnt = 7,
        .intr_priority = 0,
        .trans_queue_depth = 0,
        .flags = {
            .enable_internal_pullup = true,
        },
    };
    
    esp_err_t ret = i2c_new_master_bus(&i2c_bus_config, &i2c_bus_);
    ...
}
```

## 📊 I2C总线分配

| I2C总线 | 用途 | GPIO引脚 |
|---------|------|---------|
| I2C_NUM_0 | 板子显示器 | 板子配置 |
| I2C_NUM_1 | BMI160传感器 | GPIO17(SDA), GPIO18(SCL) |

## 🚀 编译和烧录

```bash
cd /Users/zhangzisong/Desktop/test1.1/xiaozhi-esp32-main

# 1. 设置ESP-IDF环境
. $HOME/esp/esp-idf/export.sh

# 2. 清理编译文件（重要！）
idf.py fullclean

# 3. 重新编译
idf.py build

# 4. 烧录到设备
idf.py flash

# 5. 查看日志
idf.py monitor
```

## 📝 预期日志输出

成功运行后应该看到：

```
I (xxxx) CompactWifiBoard: 初始化显示器... [使用I2C_NUM_0]
I (xxxx) SensorManager: 初始化传感器管理器...
I (xxxx) BMI160: BMI160 Chip ID: 0xD1
I (xxxx) BMI160: BMI160 初始化成功!
I (xxxx) SensorManager: BMI160传感器初始化成功!
I (xxxx) main: 传感器系统初始化成功
```

**静止时**：无传感器数据输出

**晃动时**：
```
I (xxxx) SensorManager: === 检测到晃动! ===
I (xxxx) SensorManager: 加速度 [g]: X=0.523, Y=0.412, Z=1.234 | 陀螺仪 [°/s]: X=125.42, Y=-98.34, Z=45.67
```

## ⚠️ 不应再出现的错误

以下错误已解决：
- ❌ `I2C bus id(0) has already been acquired` - 已通过使用I2C_NUM_1解决
- ❌ `I2C bus acquire failed` - 已通过使用独立总线解决
- ❌ `Bus not freed entirely` - 已通过使用独立总线解决

## 🔍 技术说明

### ESP32 I2C总线
ESP32支持两个独立的I2C硬件总线：
- **I2C_NUM_0**：第一个I2C控制器
- **I2C_NUM_1**：第二个I2C控制器

每个总线：
- 可以使用任意GPIO引脚（通过GPIO矩阵）
- 独立工作，互不干扰
- 需要单独初始化

### 为什么要用不同的总线？
因为板子的显示器已经初始化了I2C_NUM_0总线。ESP-IDF不允许同一个I2C总线被初始化两次，即使使用不同的GPIO引脚也不行。

### GPIO引脚灵活性
由于ESP32的GPIO矩阵功能，I2C_NUM_1可以使用任意可用的GPIO引脚，我们选择了GPIO17和GPIO18。

## ✅ 配置总结

| 配置项 | 值 | 说明 |
|-------|-----|------|
| I2C总线 | I2C_NUM_1 | 避免与显示器冲突 |
| SCL引脚 | GPIO18 | I2C时钟 |
| SDA引脚 | GPIO17 | I2C数据 |
| I2C频率 | 400kHz | 标准快速模式 |
| I2C地址 | 0x68 | BMI160默认地址（SAO=GND）|
| 上拉电阻 | 启用内部上拉 | 简化硬件连接 |

## 🎯 功能特性

✅ 传感器每500ms读取数据  
✅ 只在检测到晃动时打印日志  
✅ 静止时无输出，保持界面清爽  
✅ 独立I2C总线，不影响显示器  
✅ 自动初始化和错误处理  

## 📚 相关文档

- `BMI160_SENSOR_GUIDE.md` - 完整使用指南
- `BMI160_快速开始.md` - 快速入门
- `BMI160_日志简化说明.md` - 日志优化说明
- `BMI160_传感器禁用说明.md` - 禁用方法（如需要）

---

**最终配置完成**：传感器使用I2C_NUM_1总线，GPIO17(SDA)和GPIO18(SCL)，不再与显示器冲突！

