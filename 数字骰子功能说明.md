# 🎲 数字骰子功能说明

## 功能介绍

将BMI160传感器转换为一个"数字骰子"，根据设备的姿态实时检测并显示哪一面朝上（1-6）。

## 六个面的定义

```
面 1 (正面): +Z轴朝上 
面 2 (背面): -Z轴朝上
面 3 (右侧): +X轴朝上
面 4 (左侧): -X轴朝上  
面 5 (前侧): +Y轴朝上
面 6 (后侧): -Y轴朝上
```

### 坐标系说明

以设备平放、正面朝上为参考：
```
       +Y (前)
        ↑
        |
        |
-X (左) +---→ +X (右)
       /
      /
     ↓
   +Z (上)

设备平放时：
- Z轴指向天空（正面朝上）= 面1
- 翻转180度（背面朝上）= 面2  
- 向右翻转90度（右侧朝上）= 面3
- 向左翻转90度（左侧朝上）= 面4
- 向前翻转90度（前侧朝上）= 面5
- 向后翻转90度（后侧朝上）= 面6
```

## 工作原理

### 检测逻辑

1. **读取加速度计数据**：获取X、Y、Z三轴的加速度值
2. **找出重力方向**：找到绝对值最大的轴（重力总是指向地面）
3. **判断正负方向**：确定该轴是正向还是负向
4. **确定面编号**：根据轴向和方向确定1-6中的哪一面

### 核心算法

```cpp
int DetectUpwardFace(float accel_x, float accel_y, float accel_z) {
    // 找出绝对值最大的轴（重力方向）
    float abs_x = fabs(accel_x);
    float abs_y = fabs(accel_y);
    float abs_z = fabs(accel_z);
    
    // 判断哪个轴的加速度最大（即重力方向）
    if (abs_z > abs_x && abs_z > abs_y) {
        return (accel_z > 0) ? 1 : 2;  // Z轴：面1或面2
    } else if (abs_x > abs_y && abs_x > abs_z) {
        return (accel_x > 0) ? 3 : 4;  // X轴：面3或面4
    } else {
        return (accel_y > 0) ? 5 : 6;  // Y轴：面5或面6
    }
}
```

## 使用方法

### 1. 编译和烧录

```bash
cd /Users/zhangzisong/Desktop/test1.1/xiaozhi-esp32-main

# 设置环境
. $HOME/esp/esp-idf/export.sh

# 编译
idf.py build

# 烧录
idf.py flash

# 查看日志
idf.py monitor
```

### 2. 使用骰子

**启动后：**
- 系统会显示当前哪一面朝上
- 翻转设备，日志会实时更新面的编号
- 晃动设备时会额外显示晃动提示

## 日志输出示例

### 系统启动
```
I (xxxx) SensorManager: 初始化传感器管理器...
I (xxxx) BMI160: BMI160 Chip ID: 0xD1
I (xxxx) BMI160: BMI160 初始化成功!
I (xxxx) SensorManager: BMI160传感器初始化成功!
I (xxxx) SensorManager: 📦 数字骰子模式已启动！
I (xxxx) SensorManager: 面朝上说明: 1=正面, 2=背面, 3=右侧, 4=左侧, 5=前侧, 6=后侧
```

### 检测到面朝上变化
```
I (1234) SensorManager: 🎲 当前朝上: 面 1 (正面)
I (1234) SensorManager:    加速度 [g]: X=0.012, Y=-0.034, Z=0.982

[翻转设备]

I (2456) SensorManager: 🎲 当前朝上: 面 3 (右侧)
I (2456) SensorManager:    加速度 [g]: X=0.978, Y=-0.045, Z=0.023

[再次翻转]

I (3678) SensorManager: 🎲 当前朝上: 面 6 (后侧)
I (3678) SensorManager:    加速度 [g]: X=0.015, Y=-0.965, Z=0.012
```

### 晃动时
```
I (4567) SensorManager: 🎲 === 正在晃动骰子！===
I (4567) SensorManager:    陀螺仪 [°/s]: X=125.42, Y=-98.34, Z=45.67
```

## 特性

### ✅ 智能特性

1. **只在变化时打印**
   - 避免重复日志
   - 只在翻转到新面时显示

2. **双重检测**
   - 面朝上检测（基于加速度计）
   - 晃动检测（基于陀螺仪和加速度变化）

3. **中文提示**
   - 直观的面名称（正面、背面、左侧等）
   - 友好的表情符号（🎲）

### ⚙️ 技术参数

- **检测频率**：500ms（每秒2次）
- **加速度分辨率**：±2g，16位
- **陀螺仪分辨率**：±2000°/s，16位
- **响应时间**：< 0.5秒

## 应用场景

### 娱乐应用
- 🎲 电子骰子游戏
- 🎰 随机数生成器
- 🎮 体感游戏控制

### 实用应用
- 📱 设备方向检测
- 🔄 自动旋转屏幕方向
- 📊 姿态监测和记录
- 🎯 运动追踪

## 自定义配置

### 修改面的定义

如果您想自定义6个面的含义，修改 `sensor_manager.cc`：

```cpp
// 在 SensorTask 函数中修改面名称数组
const char* face_names[] = {
    "",      // 索引0不使用
    "面A",   // 面1
    "面B",   // 面2
    "面C",   // 面3
    "面D",   // 面4
    "面E",   // 面5
    "面F"    // 面6
};
```

### 调整检测灵敏度

如果面的切换太敏感或不够敏感，可以添加阈值：

```cpp
// 在 DetectUpwardFace 函数中添加
const float THRESHOLD = 0.7;  // 至少0.7g才认为是该方向

if (abs_z > THRESHOLD && abs_z > abs_x && abs_z > abs_y) {
    // Z轴判断...
}
```

### 修改检测频率

在 `SensorTask` 函数末尾修改：

```cpp
vTaskDelay(pdMS_TO_TICKS(500));  // 改为其他值（毫秒）
// 例如：250 = 每秒4次，1000 = 每秒1次
```

## 扩展功能建议

### 1. 添加防抖动
避免快速翻转时频繁切换：

```cpp
// 需要连续N次检测到同一面才确认
const int CONFIRM_COUNT = 3;
```

### 2. 记录统计
统计每个面出现的次数：

```cpp
int face_count[7] = {0};  // 记录每个面的出现次数
face_count[current_face]++;
```

### 3. 声音反馈
面变化时播放提示音

### 4. 网络上传
将面的变化上传到服务器记录

## 故障排查

### 问题1：面一直不变化
**可能原因**：传感器数据读取失败
**解决**：检查硬件连接（GPIO12/GPIO13）

### 问题2：面切换不准确
**可能原因**：设备坐标系与定义不一致
**解决**：根据实际情况重新定义面的对应关系

### 问题3：切换太频繁
**可能原因**：传感器数据抖动
**解决**：添加防抖动逻辑或增加检测间隔

## 技术细节

### 重力加速度原理

当设备静止时，加速度计测量的是重力加速度：
- 朝上的面：加速度约为 +1g
- 朝下的面：加速度约为 -1g  
- 垂直的面：加速度约为 0g

通过找出绝对值最大的轴，就能知道重力方向，从而确定哪个面朝上。

### 坐标系转换

BMI160的坐标系：
```
芯片视角：
    Y
    ↑
    |
    +--→ X
   /
  ↙
 Z
```

## 总结

✅ **已实现**：
- 6个面的定义和检测
- 实时面朝上显示
- 晃动检测
- 智能日志输出

✨ **特点**：
- 简单易用
- 实时响应
- 低功耗
- 可扩展

🎲 **现在就试试您的数字骰子吧！**

---

**祝使用愉快！** 🎉

