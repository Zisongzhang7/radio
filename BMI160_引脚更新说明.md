# BMI160 传感器引脚配置更新

## 更新时间
2025年10月23日

## 问题解决

之前使用GPIO9和GPIO8导致与板子原有I2C总线冲突，系统崩溃。

现已更新为不冲突的GPIO引脚，传感器功能已重新启用。

## 最新硬件接线

**当前配置（已更新）：**

| BMI160引脚 | ESP32引脚 | 说明 |
|-----------|----------|------|
| VIN       | 3V3      | 电源 |
| SCL       | GPIO18   | I2C时钟线 ✅ 已更新 |
| SDA       | GPIO17   | I2C数据线 ✅ 已更新 |
| CS        | 3.3V     | 片选（拉高启用I2C模式）|
| SAO       | GND      | I2C地址选择（0x68）|

## 已完成的代码修改

### 1. main/sensor_manager.cc
```cpp
// I2C配置 - 已更新
#define I2C_SCL_IO      GPIO_NUM_18  // 从GPIO9改为GPIO18
#define I2C_SDA_IO      GPIO_NUM_17  // 从GPIO8改为GPIO17
#define I2C_FREQ_HZ     400000
```

### 2. main/main.cc
- ✅ 重新启用了 `#include "sensor_manager.h"`
- ✅ 重新启用了传感器初始化代码
- ✅ 添加了注释说明当前使用的GPIO引脚

### 3. main/CMakeLists.txt
- ✅ 重新加入 `sensor_manager.cc` 到编译列表

## 引脚冲突说明

**板子原有I2C配置（用于显示器）：**
- 使用 I2C_NUM_0 总线
- 具体引脚在 `main/boards/bread-compact-wifi/config.h` 中定义

**BMI160传感器I2C配置（独立）：**
- 同样使用 I2C_NUM_0 总线，但使用不同的GPIO引脚
- GPIO17 (SDA) 和 GPIO18 (SCL)
- 这两个引脚不会与显示器I2C冲突

## 编译和烧录

请执行以下命令：

```bash
cd /Users/zhangzisong/Desktop/test1.1/xiaozhi-esp32-main

# 1. 设置ESP-IDF环境
. $HOME/esp/esp-idf/export.sh

# 2. 清理编译文件
idf.py fullclean

# 3. 重新编译
idf.py build

# 4. 烧录到设备
idf.py flash

# 5. 查看日志
idf.py monitor
```

## 预期日志输出

成功运行后应该看到：

```
I (xxxx) SensorManager: 初始化传感器管理器...
I (xxxx) BMI160: BMI160 Chip ID: 0xD1
I (xxxx) BMI160: BMI160 初始化成功!
I (xxxx) SensorManager: BMI160传感器初始化成功!
I (xxxx) main: 传感器系统初始化成功
[静止时无传感器数据输出]

[晃动设备时：]
I (xxxx) SensorManager: === 检测到晃动! ===
I (xxxx) SensorManager: 加速度 [g]: X=0.523, Y=0.412, Z=1.234 | 陀螺仪 [°/s]: X=125.42, Y=-98.34, Z=45.67
```

## 如果仍然出现问题

### 检查项：
1. ✅ 确认BMI160模块确实连接到GPIO17和GPIO18
2. ✅ 确认VIN连接到3.3V（不是5V）
3. ✅ 确认CS引脚连接到3.3V（启用I2C模式）
4. ✅ 确认SAO引脚接地（I2C地址0x68）
5. ✅ 确认所有接线牢固

### 查看GPIO17和GPIO18是否被占用

检查板子配置：
```bash
grep -r "GPIO_NUM_17\|GPIO_NUM_18\|GPIO17\|GPIO18" main/boards/bread-compact-wifi/
```

如果这两个引脚也被占用，请告知，我会帮您找其他可用的GPIO。

## 备选GPIO引脚

如果GPIO17/18仍然冲突，可以尝试以下引脚组合：
- GPIO25, GPIO26
- GPIO32, GPIO33
- GPIO4, GPIO5

## 功能特性

✅ 传感器每500ms读取数据  
✅ 只在检测到晃动时打印日志  
✅ 静止时无输出，保持界面清爽  
✅ 独立的I2C配置，不影响显示器  

---

**更新完成**：传感器已配置为使用GPIO17(SDA)和GPIO18(SCL)，功能已重新启用。

