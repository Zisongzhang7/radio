# BMI160传感器快速开始指南

## 已完成的工作 ✅

我已经为您的ESP32项目成功添加了BMI160 6轴传感器支持，包括：

### 1. 创建的新文件
- `main/boards/common/bmi160.h` - BMI160驱动头文件
- `main/boards/common/bmi160.cc` - BMI160驱动实现
- `main/sensor_manager.h` - 传感器管理器头文件  
- `main/sensor_manager.cc` - 传感器管理器实现
- `BMI160_SENSOR_GUIDE.md` - 详细使用文档

### 2. 修改的文件
- `main/CMakeLists.txt` - 添加sensor_manager.cc到编译
- `main/main.cc` - 添加传感器初始化代码

## 硬件连接确认

根据您提供的接线信息：
```
BMI160 → ESP32
VIN    → 3V3
SCL    → GPIO9
SDA    → GPIO8
CS     → 3.3V
SAO    → GND
```

代码已按照此配置进行设置。

## 编译和运行

### 步骤1：设置ESP-IDF环境
```bash
cd /Users/zhangzisong/Desktop/test1.1/xiaozhi-esp32-main

# 初始化ESP-IDF环境（根据您的安装方式选择）
# 方式1：如果使用官方安装
. $HOME/esp/esp-idf/export.sh

# 方式2：如果使用其他安装方式
# source /path/to/esp-idf/export.sh
```

### 步骤2：编译项目
```bash
idf.py build
```

### 步骤3：烧录到设备
```bash
# 连接ESP32板子，然后执行
idf.py flash
```

### 步骤4：查看日志输出
```bash
idf.py monitor
```

按 `Ctrl+]` 退出监视器。

## 预期日志输出

成功运行后，您会看到：

```
I (xxxx) SensorManager: 初始化传感器管理器...
I (xxxx) BMI160: BMI160 Chip ID: 0xD1
I (xxxx) BMI160: BMI160 初始化成功!
I (xxxx) SensorManager: BMI160传感器初始化成功!
I (xxxx) main: 传感器系统初始化成功
[设备静止时无传感器数据输出]
```

**晃动传感器时**才会显示数据：
```
I (xxxx) SensorManager: === 检测到晃动! ===
I (xxxx) SensorManager: 加速度 [g]: X=0.523, Y=0.412, Z=1.234 | 陀螺仪 [°/s]: X=125.42, Y=-98.34, Z=45.67
```

**日志简化说明**：为保持监控界面清爽，系统只在检测到晃动时才打印传感器数据，静止时无输出。

## 功能说明

✅ **自动初始化** - 系统启动时自动初始化BMI160
✅ **实时数据读取** - 每500ms读取一次传感器数据
✅ **晃动检测** - 自动检测并打印晃动事件
✅ **简洁日志** - 仅在检测到晃动时显示数据，静止时无输出

## 数据解释

### 加速度计 (单位: g)
- X、Y、Z轴的加速度
- 1g = 9.8 m/s²
- 设备静止时，Z轴约为 ±1g（重力加速度）

### 陀螺仪 (单位: °/s)  
- X、Y、Z轴的角速度
- 正值表示逆时针旋转，负值表示顺时针旋转
- 设备静止时，数值接近0

## 常见问题

### Q1: 如果看到 "传感器系统初始化失败"？
**检查项：**
1. 确认BMI160模块已正确连接到ESP32
2. 检查VIN是否连接到3.3V
3. 确认SCL连接到GPIO9，SDA连接到GPIO8
4. 确认CS引脚接到3.3V（启用I2C模式）
5. 确认SAO引脚接地

### Q2: 如果看到 "错误的芯片ID"？
**可能原因：**
- I2C地址不匹配（SAO引脚状态错误）
- I2C总线连接问题
- 传感器模块故障

**解决方法：**
- 再次确认SAO引脚接地
- 检查SCL和SDA是否接反
- 使用万用表测试连接

### Q3: 晃动检测不灵敏？
**调整方法：**
编辑 `main/boards/common/bmi160.cc` 文件中的：
```cpp
const int32_t SHAKE_THRESHOLD = 3000;  // 减小此值提高灵敏度
```

### Q4: 如何修改I2C引脚？
**修改方法：**
编辑 `main/sensor_manager.cc` 文件：
```cpp
#define I2C_SCL_IO      GPIO_NUM_9   // 当前配置
#define I2C_SDA_IO      GPIO_NUM_8   // 当前配置
```

## 技术特性

- **I2C接口**：400kHz时钟频率
- **加速度计量程**：±2g（16位分辨率）
- **陀螺仪量程**：±2000°/s（16位分辨率）
- **采样频率**：100Hz
- **读取间隔**：500ms

## 后续开发建议

基于当前的传感器数据，您可以实现：

1. **手势控制** - 通过晃动、翻转等手势控制设备
2. **姿态监测** - 检测设备的倾斜角度和方向
3. **运动追踪** - 检测设备是否在移动
4. **智能交互** - 敲击两下唤醒、摇一摇切歌等

## 获取帮助

详细技术文档请查看：`BMI160_SENSOR_GUIDE.md`

如有问题，请检查：
1. 硬件连接是否正确
2. ESP-IDF版本是否兼容
3. 串口日志的详细错误信息

---

**祝您使用愉快！** 🎉

