# é‡åŠ›æ¶ˆæ¯ä¿®å¤å®Œæˆ - å‚ç…§ MCP è°ƒç”¨æ–¹å¼

## ğŸ”§ é—®é¢˜åŸå› 

**ä¹‹å‰çš„é—®é¢˜**ï¼šæœåŠ¡å™¨èƒ½æ”¶åˆ° MCP æ¶ˆæ¯ï¼Œä½†æ”¶ä¸åˆ° gravity æ¶ˆæ¯ã€‚

**æ ¹æœ¬åŸå› **ï¼š
1. âŒ åœ¨ `sensor_manager.cc` ä¸­ç›´æ¥è°ƒç”¨ `protocol->SendGravityMessage()`
2. âŒ ç¼ºå°‘ `Application` å±‚çš„å°è£…
3. âŒ æ²¡æœ‰æ­£ç¡®çš„çº¿ç¨‹å®‰å…¨æ£€æŸ¥å’Œç©ºæŒ‡é’ˆä¿æŠ¤

**MCP çš„æ­£ç¡®è°ƒç”¨æ–¹å¼**ï¼š
```cpp
// MCP é€šè¿‡ Application å±‚è°ƒç”¨
app.SendMcpMessage(payload);

// Application::SendMcpMessage å†…éƒ¨ä¼šï¼š
// 1. æ£€æŸ¥ protocol æ˜¯å¦ä¸ºç©º
// 2. æ£€æŸ¥å½“å‰çº¿ç¨‹
// 3. å¦‚æœä¸åœ¨ä¸»çº¿ç¨‹ï¼Œé€šè¿‡ Schedule åˆ‡æ¢
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

**å‚ç…§ `SendMcpMessage` çš„å®ç°æ–¹å¼**ï¼Œä¸º `SendGravityMessage` æ·»åŠ å®Œæ•´çš„ Application å±‚å°è£…ã€‚

---

## ğŸ“ ä¿®æ”¹å†…å®¹

### 1. Application.h - æ·»åŠ å…¬å…±æ–¹æ³•

**æ–‡ä»¶**: `main/application.h` (è¡Œ65)

```cpp
void SendMcpMessage(const std::string& payload);
void SendGravityMessage(const std::string& model);  // æ–°å¢
```

---

### 2. Application.cc - å®ç°æ–¹æ³•ï¼ˆå®Œå…¨å‚ç…§ SendMcpMessageï¼‰

**æ–‡ä»¶**: `main/application.cc` (è¡Œ942-955)

```cpp
void Application::SendGravityMessage(const std::string& model) {
    if (protocol_ == nullptr) {
        return;
    }

    // Make sure you are using main thread to send gravity message
    if (xTaskGetCurrentTaskHandle() == main_event_loop_task_handle_) {
        protocol_->SendGravityMessage(model);
    } else {
        Schedule([this, model = std::move(model)]() {
            protocol_->SendGravityMessage(model);
        });
    }
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… ç©ºæŒ‡é’ˆæ£€æŸ¥ï¼š`if (protocol_ == nullptr) return;`
- âœ… çº¿ç¨‹æ£€æŸ¥ï¼šåˆ¤æ–­æ˜¯å¦åœ¨ä¸»çº¿ç¨‹
- âœ… è‡ªåŠ¨åˆ‡æ¢ï¼šå¦‚æœä¸åœ¨ä¸»çº¿ç¨‹ï¼Œé€šè¿‡ `Schedule` è°ƒåº¦åˆ°ä¸»çº¿ç¨‹
- âœ… å‚æ•°ç§»åŠ¨è¯­ä¹‰ï¼š`std::move(model)` é¿å…æ‹·è´

---

### 3. sensor_manager.cc - ç®€åŒ–è°ƒç”¨æ–¹å¼

**ä¿®æ”¹å‰**ï¼ˆå¤æ‚ä¸”ä¸å®Œæ•´ï¼‰ï¼š
```cpp
case 2:
    ESP_LOGI(TAG, "ğŸŸ¢ å§¿æ€è§¦å‘ï¼šå‘é€é‡åŠ›æ¨¡å‹2");
    app.Schedule([&app]() {
        app.PlaySound(Lang::Sounds::OGG_POPUP);
        auto* protocol = app.GetProtocol();
        if (protocol != nullptr) {
            ESP_LOGI(TAG, "Protocol å¯ç”¨ï¼Œå‡†å¤‡å‘é€ gravityModel_2");
            if (protocol->IsAudioChannelOpened()) {
                ESP_LOGI(TAG, "éŸ³é¢‘é€šé“å·²æ‰“å¼€ï¼Œsession_id: %s", protocol->session_id().c_str());
            } else {
                ESP_LOGW(TAG, "éŸ³é¢‘é€šé“æœªæ‰“å¼€ï¼Œä½†ä»å°è¯•å‘é€æ¶ˆæ¯");
            }
            protocol->SendGravityMessage("gravityModel_2");
        } else {
            ESP_LOGE(TAG, "Protocol ä¸ºç©ºï¼Œæ— æ³•å‘é€æ¶ˆæ¯ï¼");
        }
    });
    last_triggered_face = 2;
    break;
```

**ä¿®æ”¹å**ï¼ˆç®€æ´ä¸”æ­£ç¡®ï¼‰ï¼š
```cpp
case 2:
    ESP_LOGI(TAG, "ğŸŸ¢ å§¿æ€è§¦å‘ï¼šå‘é€é‡åŠ›æ¨¡å‹2");
    app.PlaySound(Lang::Sounds::OGG_POPUP);
    app.SendGravityMessage("gravityModel_2");
    last_triggered_face = 2;
    break;
```

**åŒæ ·ä¿®æ”¹äº†é¢3å’Œé¢4**ã€‚

---

## ğŸ”„ è°ƒç”¨æµç¨‹å¯¹æ¯”

### MCP æ¶ˆæ¯æµç¨‹ï¼ˆæ­£ç¡®ï¼‰
```
mcp_server.cc è°ƒç”¨:
    app.SendMcpMessage(payload)
        â†“
Application::SendMcpMessage
    â†’ æ£€æŸ¥ protocol æ˜¯å¦ä¸ºç©º
    â†’ æ£€æŸ¥å½“å‰çº¿ç¨‹
    â†’ å¦‚æœä¸åœ¨ä¸»çº¿ç¨‹ï¼ŒSchedule åˆ°ä¸»çº¿ç¨‹
        â†“
protocol_->SendMcpMessage(payload)
        â†“
æ„é€  JSON: {"session_id":"xxx","type":"mcp","payload":{...}}
        â†“
SendText() â†’ å‘é€åˆ°æœåŠ¡å™¨ âœ…
```

### Gravity æ¶ˆæ¯æµç¨‹ï¼ˆç°åœ¨ä¹Ÿæ­£ç¡®äº†ï¼‰
```
sensor_manager.cc è°ƒç”¨:
    app.SendGravityMessage("gravityModel_2")
        â†“
Application::SendGravityMessage
    â†’ æ£€æŸ¥ protocol æ˜¯å¦ä¸ºç©º
    â†’ æ£€æŸ¥å½“å‰çº¿ç¨‹
    â†’ å¦‚æœä¸åœ¨ä¸»çº¿ç¨‹ï¼ŒSchedule åˆ°ä¸»çº¿ç¨‹
        â†“
protocol_->SendGravityMessage("gravityModel_2")
        â†“
æ„é€  JSON: {"session_id":"xxx","type":"gravity","model":"gravityModel_2"}
        â†“
SendText() â†’ å‘é€åˆ°æœåŠ¡å™¨ âœ…
```

---

## ğŸ“Š æ¶ˆæ¯æ ¼å¼

è®¾å¤‡å‘é€åˆ°æœåŠ¡å™¨çš„æ¶ˆæ¯ï¼š

```json
{
  "session_id": "xxx",
  "type": "gravity",
  "model": "gravityModel_2"
}
```

**æ³¨æ„**ï¼šè¿™æ˜¯é¡¶çº§çš„ `type: "gravity"` æ¶ˆæ¯ï¼Œ**ä¸æ˜¯** MCP payloadã€‚

---

## ğŸ¯ ä¸ºä»€ä¹ˆç°åœ¨èƒ½å·¥ä½œäº†

| é—®é¢˜ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| **ç©ºæŒ‡é’ˆæ£€æŸ¥** | âŒ æ‰‹åŠ¨æ£€æŸ¥ï¼Œå®¹æ˜“é—æ¼ | âœ… Application å±‚ç»Ÿä¸€æ£€æŸ¥ |
| **çº¿ç¨‹å®‰å…¨** | âš ï¸ ç”¨äº† Schedule ä½†ä¸å®Œæ•´ | âœ… å®Œæ•´çš„çº¿ç¨‹æ£€æŸ¥å’Œåˆ‡æ¢ |
| **è°ƒç”¨å¤æ‚åº¦** | âŒ éœ€è¦æ‰‹åŠ¨å¤„ç†å¾ˆå¤šç»†èŠ‚ | âœ… ä¸€è¡Œä»£ç æå®š |
| **ä¸ MCP ä¸€è‡´æ€§** | âŒ è°ƒç”¨æ–¹å¼ä¸åŒ | âœ… å®Œå…¨ä¸€è‡´ |

---

## ğŸš€ ç¼–è¯‘å’Œæµ‹è¯•

```bash
cd /Users/zhangzisong/Desktop/test1.1/xiaozhi-esp32-main
. ~/esp/esp-idf/export.sh
idf.py build
idf.py flash
idf.py monitor
```

---

## ğŸ“¡ é¢„æœŸæ—¥å¿—

ç¿»è½¬åˆ°é¢2æ—¶ï¼š

```
I (xxx) SensorManager: ğŸ² å½“å‰æœä¸Š: é¢ 2 (èƒŒé¢)
I (xxx) SensorManager: ğŸŸ¢ å§¿æ€è§¦å‘ï¼šå‘é€é‡åŠ›æ¨¡å‹2
I (xxx) Protocol: Sending gravity message: gravityModel_2
```

**å…³é”®**ï¼šç°åœ¨ä¸ä¼šæœ‰ "Protocol ä¸ºç©º" çš„é”™è¯¯ï¼Œå› ä¸º Application å±‚å·²ç»å¤„ç†äº†ã€‚

---

## ğŸŒ æœåŠ¡å™¨ç«¯å¤„ç†

æœåŠ¡å™¨éœ€è¦å¤„ç†é¡¶çº§çš„ `type: "gravity"` æ¶ˆæ¯ï¼š

### WebSocket å¤„ç†ç¤ºä¾‹

```python
def handle_websocket_message(data):
    msg_type = data.get("type")
    
    # å¤„ç† MCP æ¶ˆæ¯
    if msg_type == "mcp":
        handle_mcp_message(data)
    
    # å¤„ç† gravity æ¶ˆæ¯ï¼ˆæ–°å¢ï¼‰
    elif msg_type == "gravity":
        model = data.get("model")
        session_id = data.get("session_id")
        
        print(f"æ”¶åˆ°é‡åŠ›æ¶ˆæ¯: {model} from {session_id}")
        
        if model == "gravityModel_2":
            # èƒŒé¢æœä¸Š
            send_response(session_id, "æ”¶åˆ°èƒŒé¢æœä¸Šä¿¡å·")
        elif model == "gravityModel_3":
            # å³ä¾§æœä¸Š
            send_response(session_id, "æ”¶åˆ°å³ä¾§æœä¸Šä¿¡å·")
        elif model == "gravityModel_4":
            # å·¦ä¾§æœä¸Š
            send_response(session_id, "æ”¶åˆ°å·¦ä¾§æœä¸Šä¿¡å·")
```

### MQTT å¤„ç†ç¤ºä¾‹

```python
def on_message(client, userdata, message):
    data = json.loads(message.payload)
    msg_type = data.get("type")
    
    if msg_type == "gravity":
        model = data.get("model")
        print(f"MQTT æ”¶åˆ°é‡åŠ›æ¶ˆæ¯: {model}")
        # å¤„ç†é€»è¾‘
```

---

## ğŸ” å…³é”®å·®å¼‚è¯´æ˜

### Gravity æ¶ˆæ¯ï¼ˆæœ¬æ¬¡å®ç°ï¼‰

```json
{
  "type": "gravity",          â† é¡¶çº§ç±»å‹
  "model": "gravityModel_2",
  "session_id": "xxx"
}
```

### å¦‚æœç”¨ MCP åŒ…è£…ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰

```json
{
  "type": "mcp",              â† é¡¶çº§ç±»å‹æ˜¯ mcp
  "payload": {
    "type": "gravity",        â† gravity åœ¨ payload é‡Œ
    "model": "gravityModel_2"
  },
  "session_id": "xxx"
}
```

**å½“å‰å®ç°**ï¼šgravity æ˜¯é¡¶çº§æ¶ˆæ¯ç±»å‹ï¼Œä¸ `listen`ã€`mcp` ç­‰åŒçº§ã€‚

---

## âœ… å®Œæˆçš„ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| `main/application.h` | æ·»åŠ  `SendGravityMessage` æ–¹æ³•å£°æ˜ | 65 |
| `main/application.cc` | å®ç° `SendGravityMessage` æ–¹æ³• | 942-955 |
| `main/sensor_manager.cc` | ç®€åŒ–é¢2/3/4çš„è°ƒç”¨æ–¹å¼ | 180-202 |
| `main/protocols/protocol.h` | å·²æœ‰ `SendGravityMessage` å£°æ˜ | 76 |
| `main/protocols/protocol.cc` | å·²æœ‰ `SendGravityMessage` å®ç° | 81-86 |

---

## ğŸ’¡ æ ¸å¿ƒç»éªŒ

**é‡è¦æ•™è®­**ï¼š
1. âœ… æ‰€æœ‰è®¾å¤‡åˆ°æœåŠ¡å™¨çš„æ¶ˆæ¯éƒ½åº”è¯¥é€šè¿‡ `Application` å±‚å‘é€
2. âœ… å‚ç…§ç°æœ‰çš„æ¶ˆæ¯ç±»å‹å®ç°ï¼ˆå¦‚ MCPï¼‰
3. âœ… ä¸è¦åœ¨å­ç³»ç»Ÿï¼ˆå¦‚ sensor_managerï¼‰ä¸­ç›´æ¥è®¿é—® protocol
4. âœ… çº¿ç¨‹å®‰å…¨ç”± Application å±‚ç»Ÿä¸€å¤„ç†

**æœ€ä½³å®è·µ**ï¼š
```cpp
// âœ… æ­£ç¡®ï¼šé€šè¿‡ Application å±‚
app.SendGravityMessage("gravityModel_2");

// âŒ é”™è¯¯ï¼šç›´æ¥è°ƒç”¨ protocol
app.GetProtocol()->SendGravityMessage("gravityModel_2");
```

---

## ğŸ§ª éªŒè¯æ¸…å•

- [ ] é‡æ–°ç¼–è¯‘æˆåŠŸ
- [ ] çƒ§å½•åˆ°è®¾å¤‡
- [ ] ç¿»è½¬åˆ°é¢2ï¼ŒæŸ¥çœ‹æ—¥å¿—
- [ ] ç¡®è®¤çœ‹åˆ° "Sending gravity message: gravityModel_2"
- [ ] æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤æ”¶åˆ° `type: "gravity"` æ¶ˆæ¯
- [ ] æœåŠ¡å™¨æ­£ç¡®å¤„ç†å¹¶å“åº”

---

**æœ€åæ›´æ–°**: 2025å¹´10æœˆ24æ—¥  
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆ  
**æ–¹æ³•**: å‚ç…§ SendMcpMessage çš„ Application å±‚å°è£…

