# BMI160 I2C连接测试指南

## 当前配置

```
板子类型：bread-compact-wifi
I2C总线：I2C_NUM_0
SCL引脚：GPIO18
SDA引脚：GPIO17
I2C地址：0x68（SAO接GND）
```

## 正确接线图

```
BMI160          ESP32
──────         ───────
VIN/VCC   →    3.3V    ✓ 必须是3.3V，不是5V！
GND       →    GND     ✓ 共地
SCL       →    GPIO18  ✓ 时钟线
SDA       →    GPIO17  ✓ 数据线
CS        →    3.3V    ✓ 必须接高电平启用I2C！
SAO/SDO   →    GND     ✓ 地址选择（0x68）
```

## 检查清单

### 🔋 电源检查
- [ ] 用万用表测量BMI160的VIN引脚：应该是3.3V
- [ ] 用万用表测量BMI160的GND引脚：应该是0V
- [ ] BMI160模块上的LED亮了吗（如果有）？

### 🔌 接线检查
- [ ] VIN确实接到3.3V（不是5V）
- [ ] GND确实接到GND
- [ ] SCL确实接到GPIO18（不是其他引脚）
- [ ] SDA确实接到GPIO17（不是其他引脚）
- [ ] CS确实接到3.3V（**非常重要！**）
- [ ] SAO/SDO确实接到GND

### 🔧 物理检查
- [ ] 所有杜邦线插紧，无松动
- [ ] 面包板接触良好（如果使用）
- [ ] 线材完好，无断线或破损
- [ ] ESP32和BMI160模块都稳固放置

## 最容易忽略的问题

### ⚠️ 问题1：CS引脚未接
**症状**：I2C完全无响应
**原因**：BMI160进入SPI模式而不是I2C模式
**解决**：CS引脚必须接到3.3V或VCC

### ⚠️ 问题2：VIN接到5V
**症状**：可能损坏传感器或ESP32
**原因**：ESP32是3.3V逻辑电平
**解决**：改接到3.3V

### ⚠️ 问题3：SCL和SDA接反
**症状**：I2C通讯失败
**解决**：仔细对照接线图

### ⚠️ 问题4：SAO引脚悬空
**症状**：I2C地址不确定
**解决**：SAO接GND（地址0x68）或VCC（地址0x69）

## 使用万用表测试

### 测试步骤

**1. ESP32通电前：**
- 断开ESP32电源
- 检查所有接线
- 用万用表电阻档检查线路连通性

**2. ESP32通电后：**
```
测量点1：BMI160的VIN → GND
期望值：3.3V ± 0.2V

测量点2：BMI160的CS → GND
期望值：3.3V ± 0.2V

测量点3：BMI160的SAO → GND
期望值：0V（接近0）

测量点4：GPIO18（SCL）
期望值：电压应该跳变（I2C通讯）

测量点5：GPIO17（SDA）
期望值：电压应该跳变（I2C通讯）
```

## 模块类型确认

BMI160模块有多种版本，确认您的模块：

### 常见模块类型

**类型1：6引脚模块**
```
VCC - 电源正极
GND - 电源负极
SCL - I2C时钟
SDA - I2C数据
CS  - 片选（I2C模式需接高）
SAO - 地址选择
```

**类型2：带LDO的模块**
- 有些模块内置3.3V稳压器
- 可以接5V（检查模块标注）

**类型3：GY-BMI160模块**
- 通常有6个引脚
- CS引脚必须接高

## 替代测试方法

### 方法1：使用逻辑分析仪
如果您有逻辑分析仪：
- 连接到SCL（GPIO18）和SDA（GPIO17）
- 捕获I2C信号
- 查看是否有START信号

### 方法2：更换GPIO引脚
尝试使用其他GPIO引脚：
```cpp
// 在 sensor_manager.cc 中修改
#define I2C_SCL_IO      GPIO_NUM_22  // 尝试其他引脚
#define I2C_SDA_IO      GPIO_NUM_21  // 尝试其他引脚
```

### 方法3：降低I2C速度
```cpp
// 在 i2c_device.cc 中修改
.scl_speed_hz = 100 * 1000,  // 从400kHz降到100kHz
```

## 测试步骤建议

### 步骤1：基础测试
1. 断开ESP32电源
2. 重新仔细检查所有接线
3. 特别确认CS接到3.3V
4. 通电，查看日志

### 步骤2：如果还是失败
1. 尝试交换SCL和SDA（确认是否接反）
2. 用另一根线替换可能有问题的杜邦线
3. 如果使用面包板，换个位置试试

### 步骤3：确认模块是否损坏
1. 用万用表测量BMI160芯片本身的VCC引脚（芯片上）
2. 如果电压正常但不工作，可能模块损坏
3. 尝试用另一个BMI160模块

## 预期正常日志

如果连接正确，您应该看到：

```
I (xxxx) SensorManager: 初始化传感器管理器...
I (xxxx) BMI160: 正在检测BMI160传感器...
I (xxxx) BMI160: BMI160 Chip ID: 0xD1
I (xxxx) BMI160: BMI160 初始化成功!
I (xxxx) SensorManager: BMI160传感器初始化成功!
```

## 当前错误日志分析

您看到的错误：
```
E (6633) i2c.master: i2c_master_transmit_receive(1248): I2C transaction failed
W (6633) I2cDevice: I2C读多个寄存器失败 (reg=0x0C, len=6): ESP_ERR_INVALID_STATE
E (6643) SensorManager: 读取传感器数据失败
```

**这表示：**
- I2C总线初始化成功（否则会有其他错误）
- 但是无法与传感器通讯
- **最可能的原因：传感器未连接或接线错误**

## 紧急提示

### 🚨 如果您发现CS引脚没接

**这是最常见的问题！**

BMI160的CS引脚：
- 接高电平（3.3V）→ I2C模式
- 接低电平（GND）→ SPI模式
- 悬空 → 不确定，可能不工作

**立即检查并确保CS接到3.3V！**

## 需要帮助？

如果按照以上步骤还是不行，请提供：
1. BMI160模块的照片（特别是引脚标注）
2. 实际接线的照片
3. 万用表测量的电压值
4. 您使用的是什么型号的ESP32板

我可以进一步帮您诊断！

