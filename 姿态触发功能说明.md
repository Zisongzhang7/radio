# 姿态触发功能说明

## 📌 当前状态

**状态**: ❌ **已禁用**  
**修改时间**: 2025年10月24日

---

## 🔧 修改内容

### 已禁用的功能

所有面触发事件已被注释掉，包括：

1. ❌ **面2（背面朝上）→ AI对话模式**
   - 不再播放提示音
   - 不再调用 `ToggleChatState()`
   - 不再进入监听状态

2. ❌ **面4（左侧朝上）→ 播客请求**
   - 不再播放提示音
   - 不再发送 MCP 消息
   - 不再请求"最近一期的看世界"

### 保留的功能

✅ **面检测和显示功能仍然正常工作**：
- 传感器继续读取加速度数据
- 数字骰子模式正常运行
- 日志会显示当前朝上的面

---

## 📊 当前日志输出

### 启动时
```
I (xxx) SensorManager: 📦 数字骰子模式已启动！
I (xxx) SensorManager: 面朝上说明: 1=正面, 2=背面, 3=右侧, 4=左侧, 5=前侧, 6=后侧
```

**注意**: "姿态控制已启用" 的提示已被隐藏

### 翻转设备时
```
I (xxx) SensorManager: 🎲 当前朝上: 面 1 (正面)

[翻转到背面 - 不会触发任何功能]

I (xxx) SensorManager: 🎲 当前朝上: 面 2 (背面)

[翻转到左侧 - 不会触发任何功能]

I (xxx) SensorManager: 🎲 当前朝上: 面 4 (左侧)
```

**现在只显示面的变化，不会触发任何操作**

---

## 🔄 如何重新启用功能

如果您想重新启用姿态触发功能，请按以下步骤操作：

### 步骤 1：编辑文件

打开文件：`main/sensor_manager.cc`

### 步骤 2：找到禁用代码块

在第 143 行附近找到：
```cpp
// ESP_LOGI(TAG, "🎛️ 姿态控制已启用: 面2=AI对话, 面4=播客请求");  // 已禁用
```

取消注释：
```cpp
ESP_LOGI(TAG, "🎛️ 姿态控制已启用: 面2=AI对话, 面4=播客请求");
```

### 步骤 3：启用触发逻辑

在第 162-193 行附近找到：
```cpp
// ========== 姿态触发逻辑已禁用 ==========
// 如需启用，取消下面代码的注释
/*
// 姿态触发逻辑：只在首次翻转到目标面时触发
if (current_face == 2 && last_triggered_face != 2) {
    ...
}
...
*/
// ========== 姿态触发逻辑已禁用 ==========
```

删除 `/*` 和 `*/` 以及注释行：
```cpp
// 姿态触发逻辑：只在首次翻转到目标面时触发
if (current_face == 2 && last_triggered_face != 2) {
    // 面2（背面）：进入AI对话模式
    ESP_LOGI(TAG, "🎤 姿态触发：进入AI对话模式");
    Application::GetInstance().PlaySound(Lang::Sounds::OGG_POPUP);
    Application::GetInstance().ToggleChatState();
    last_triggered_face = 2;
} else if (current_face == 4 && last_triggered_face != 4) {
    // 面4（左侧）：请求播客
    ESP_LOGI(TAG, "🎙️ 姿态触发：请求播客 - 最近一期的看世界");
    Application::GetInstance().PlaySound(Lang::Sounds::OGG_POPUP);
    
    // 构造MCP消息
    cJSON* request = cJSON_CreateObject();
    cJSON_AddStringToObject(request, "action", "request_podcast");
    cJSON_AddStringToObject(request, "query", "最近一期的看世界");
    char* json_str = cJSON_PrintUnformatted(request);
    std::string payload = json_str;
    free(json_str);
    cJSON_Delete(request);
    
    Application::GetInstance().SendMcpMessage(payload);
    last_triggered_face = 4;
} else if (current_face != 2 && current_face != 4) {
    // 翻转到其他面时，更新 last_triggered_face，允许下次重新触发
    last_triggered_face = current_face;
}
```

### 步骤 4：重新编译

```bash
. ~/esp/esp-idf/export.sh
idf.py build
idf.py flash
```

---

## 📂 相关文件

| 文件 | 说明 |
|------|------|
| `main/sensor_manager.cc` | 传感器管理代码（包含禁用的触发逻辑） |
| `硬件接线图.md` | 硬件连接说明 |
| `BMI160_SENSOR_GUIDE.md` | BMI160传感器集成指南 |

---

## ⚙️ 技术细节

### 禁用方式

使用 C/C++ 多行注释 `/* ... */` 包裹触发逻辑代码：

**优点**：
- ✅ 代码完整保留，随时可以恢复
- ✅ 注释清晰，易于理解
- ✅ 不影响其他功能
- ✅ 编译检查通过，无警告

**被禁用的代码行**：
- 第 165-191 行：面触发逻辑

### 变量保留

以下变量虽然未使用，但已保留以便将来启用：
- `last_triggered_face` - 记录上次触发的面

---

## 🎯 面定义（参考）

| 面编号 | 方向 | 轴向 | 原触发功能（已禁用） |
|--------|------|------|-------------------|
| 1 | 正面 | +Z | 无 |
| **2** | **背面** | **-Z** | ~~AI对话模式~~ |
| 3 | 右侧 | +X | 无 |
| **4** | **左侧** | **-X** | ~~播客请求~~ |
| 5 | 前侧 | +Y | 无 |
| 6 | 后侧 | -Y | 无 |

---

## 📝 版本历史

| 日期 | 版本 | 变更内容 |
|------|------|---------|
| 2025-10-24 | 1.1 | 禁用所有面触发事件 |
| 2025-10-24 | 1.0 | 实现姿态触发功能 |

---

**最后更新**: 2025年10月24日  
**状态**: 姿态触发功能已禁用  
**面检测**: 仍然正常工作

